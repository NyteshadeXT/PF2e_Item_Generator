<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{ page_title or ("Player View — " ~ (shop_name or ((shop_type or "Shop") | title))) }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='pf2e.css') }}">
  <style>
    /* Player-view specific tweaks (optional) */
    .gm-only { display:none !important; }
    .pf-page-actions { display:none; } /* no export/debug buttons for players */
    .name-cell a { font-weight: 700; }
  </style>
</head>
<body>
  <a id="top"></a>
  <main class="pf-app">
	<header class="pf-page-header">
	  <div class="pf-page-header__inner">
		<div class="pf-page-title">
		  <span class="pf-kicker">Player View</span>
            <h1>{{ shop_name or ((shop_type or "Shop") | title) }}</h1>
		</div>
	  </div>
        </header>

        {% if channel and roll_id %}
        <section class="pf-card mt-16" id="share-controls">
          <div class="p-12" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <span class="pf-kicker" style="margin-right:8px;">Share Link</span>
            <button type="button" class="pf-btn" id="copy-share-link">Copy player link</button>
            <span id="copy-share-status" aria-live="polite" class="pf-muted"></span>
          </div>
        </section>
        {% endif %}
		
    {# ---------- helper macro for a section table ---------- #}
    {% macro section(title, items) -%}
      <section class="pf-card mt-16" id="{{ title|lower|replace(' ', '-') }}">
        <div class="pf-section__header">
          <span class="table-title">
            <span>{{ title }}</span>
            <span class="pill">{{ items|length }}</span>
          </span>
        </div>

        <div class="p-12">
          {% if not items %}
            <span class="empty">No inventory available at this time</span>
          {% else %}
            <div class="pf-table-wrap">
              <table class="pf-table zebra compact">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Level</th>
                    <th>Price</th>
                    <th>Qty</th>
                  </tr>
                </thead>
                <tbody>
                {% for it in items %}
                  {% set is_sb = (it.source_table or '')|lower == 'spellbook' %}
                  <tr class="mi-row {% if is_sb %}is-spellbook{% endif %}">
                    <td class="name-cell">
                      {% if is_sb and it.details_html %}
                        <details class="sb-acc">
                          <summary>
                            <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">
                              {{ it.name }}
                            </a>
                          </summary>
                          {{ it.details_html | safe }}
                        </details>
                      {% else %}
                        <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">
                          {{ it.name }}
                        </a>
                      {% endif %}
                    </td>
                    <td>{{ it.level }}</td>
                    <td>{{ it.price }}</td>
                    <td>{{ it.quantity }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </section>
    {%- endmacro %}

    <!-- Mundane -->
    <section id="Mundane" class="pf-card mt-16">
      <div class="pf-section__header"><h2 style="margin:0;">Mundane Items</h2><a href="#top" class="pf-link-chip" style="float: right;">↑ Top</a></div>
      {% if mundane_items %}
        <div class="p-12">
          <div class="pf-table-wrap">
            <table id="RarityMundane" class="pf-table zebra">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Level</th>
                  <th>Rarity</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Category</th>
				  <th>Source</th>
                </tr>
              </thead>
              <tbody>
                {% for it in mundane_items %}
				<tr>
                    <td>
                      <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">{{ it.name }}</a>
                      {% if it.critical %}<span class="badge critical" style="margin-left:6px;">Critical</span>{% endif %}
					  {% if it.is_3pp %}
						<span class="badge thirdparty">3PP</span>
					  {% endif %}
                    </td>
                    <td>{{ it.level }}</td>
				    <td>
					  {% set r = (it.rarity or 'Common')|lower %}
					  <span class="badge rarity-chip {{ r }}">{{ it.rarity or 'Common' }}</span>
				    </td>
				<td>{{ it.price }}</td>
				<td>{{ it.quantity }}</td>
				<td>{{ it.category }}</td>
				<td>{{ it.Source or "—" }}</td>
				</tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <p class="empty">No mundane inventory available at this time.</p>
      {% endif %}
    </section>

	<!-- Materials -->
	<section id="Materials" class="pf-card mt-16">
	  <div class="pf-section__header"><h2 style="margin:0;">Materials</h2><a href="#top" class="pf-link-chip" style="float: right;">↑ Top</a></div>
	  {% if material_items %}
		<div class="p-12">
		  <div class="pf-table-wrap">
			<table id="RarityMaterials" class="pf-table zebra">
			  <thead>
				<tr>
				  <th>Name</th>
				  <th>Level</th>
				  <th>Rarity</th>
				  <th>Price</th>
				  <th>Quantity</th>
				  <th>Category</th>
				  <th>Source</th>
				</tr>
			  </thead>
			  <tbody>
				{% for it in material_items %}
				  <tr>
					<td>
					  <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">{{ it.name }}</a>
					  {% if it.critical %}<span class="badge critical" style="margin-left:6px;">Critical</span>{% endif %}
					  {% if it.is_3pp %}
						<span class="badge thirdparty">3PP</span>
					  {% endif %}
					</td>
					<td>{{ it.level }}</td>
				    <td>
					  {% set r = (it.rarity or 'Common')|lower %}
					  <span class="badge rarity-chip {{ r }}">{{ it.rarity or 'Common' }}</span>
				    </td>
					<td>{{ it.price }}</td>
					<td>{{ it.quantity }}</td>
					<td>{{ it.category }}</td>
					<td>{{ it.Source or "—" }}</td>
				  </tr>
				{% endfor %}
			  </tbody>
			</table>
		  </div>
		</div>
	  {% else %}
		<p class="empty">No material inventory available at this time.</p>
	  {% endif %}
	</section>

	<!-- Formulas -->
	<section id="Formulas" class="pf-card mt-16">
	  <div class="pf-section__header"><h2 style="margin:0;">Formulas</h2><a href="#top" class="pf-link-chip" style="float: right;">↑ Top</a></div>
	  {% if formula_items %}
		<div class="p-12">
		  <div class="pf-table-wrap">
			<table id="RarityFormulas" class="pf-table zebra">
			  <thead>
				<tr>
				  <th>Name</th>
				  <th>Level</th>
				  <th>Rarity</th>
				  <th>Price</th>
				  <th>Quantity</th>
				  <th>Category</th>
				  <th>Source</th>
				</tr>
			  </thead>
			  <tbody>
				{% for it in formula_items %}
				  <tr>
					<td>
					  <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">{{ it.name }}</a>
					  {% if it.critical %}<span class="badge critical" style="margin-left:6px;">Critical</span>{% endif %}
					  {% if it.is_3pp %}
						<span class="badge thirdparty">3PP</span>
					  {% endif %}
					</td>
				    <td>
					  {% set r = (it.rarity or 'Common')|lower %}
					  <span class="badge rarity-chip {{ r }}">{{ it.rarity or 'Common' }}</span>
				    </td>
					<td>{{ it.price }}</td>
					<td>{{ it.quantity }}</td>
					<td>{{ it.category }}</td>
					<td>{{ it.Source or "—" }}</td>
				  </tr>
				{% endfor %}
			  </tbody>
			</table>
		  </div>
		</div>
	  {% else %}
		<p class="empty">No formula inventory available at this time</p>
	  {% endif %}
	</section>

    <!-- Armor (incl. Shields) -->
    <section id="Armor" class="pf-card mt-16">
      <div class="pf-section__header"><h2 style="margin:0;">Armor (incl. Shields)</h2><a href="#top" class="pf-link-chip" style="float: right;">↑ Top</a></div>
      {% if armor_items %}
        <div class="p-12">
          <div class="pf-table-wrap">
            <table id="RarityArmor" class="pf-table zebra">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Level</th>
                  <th>Rarity</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Category</th>
				  <th>Source</th>
                </tr>
              </thead>
              <tbody>
                {% for it in armor_items %}
                  <tr>
					<td>
					  <a href="{{ aon_url(it.base_name or it.name) }}" target="_blank" rel="noopener">
						{{ it.name }}
					  </a>
					  {% if it.critical %}
						<span class="badge critical" style="margin-left:6px;">Critical</span>
					  {% endif %}

					  {% if it.is_adjusted or ('adjustment:' in (it.tags or '')|lower) %}
						<span class="badge adjusted" style="margin-left:6px;">Adjusted</span>
					  {% endif %}
					  
					  {% if it.is_material or ('material:' in (it.tags or '')|lower) %}
					    <span class="badge material" style="margin-left:6px;">Material</span>
					  {% endif %}
					  {% if it.is_3pp %}
						<span class="badge thirdparty">3PP</span>
					  {% endif %}
					</td>
                    <td>{{ it.level }}</td>
				    <td>
					  {% set r = (it.rarity or 'Common')|lower %}
					  <span class="badge rarity-chip {{ r }}">{{ it.rarity or 'Common' }}</span>
				    </td>
                    <td>{{ it.price }}</td>
                    <td>{{ it.quantity }}</td>
                    <td>{{ it.category }}</td>
					<td>{{ it.Source or "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <p class="empty">No armor inventory available at this time.</p>
      {% endif %}
    </section>

    <!-- Weapons -->
    <section id="Weapons" class="pf-card mt-16">
      <div class="pf-section__header"><h2 style="margin:0;">Weapons</h2><a href="#top" class="pf-link-chip" style="float: right;">↑ Top</a></div>
      {% if weapon_items %}
        <div class="p-12">
          <div class="pf-table-wrap">
            <table id="RarityWeapons" class="pf-table zebra">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Level</th>
                  <th>Rarity</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Category</th>
				  <th>Source</th>
                </tr>
              </thead>
              <tbody>
                {% for it in weapon_items %}
                  <tr>
					<td>
					  <a href="{{ aon_url(it.base_name or it.name) }}" target="_blank" rel="noopener">
						{{ it.name }}
					  </a>
					  {% if it.critical %}
						<span class="badge critical" style="margin-left:6px;">Critical</span>
					  {% endif %}

					  {% if it.is_adjusted or ('adjustment:' in (it.tags or '')|lower) %}
						<span class="badge adjusted" style="margin-left:6px;">Adjusted</span>
					  {% endif %}
					  
					  {% if it.is_material or ('material:' in (it.tags or '')|lower) %}
					    <span class="badge material" style="margin-left:6px;">Material</span>
					  {% endif %}
					  {% if it.is_3pp %}
						<span class="badge thirdparty">3PP</span>
					  {% endif %}
					</td>
                    <td>{{ it.level }}</td>
				    <td>
					  {% set r = (it.rarity or 'Common')|lower %}
					  <span class="badge rarity-chip {{ r }}">{{ it.rarity or 'Common' }}</span>
				    </td>
                    <td>{{ it.price }}</td>
                    <td>{{ it.quantity }}</td>
                    <td>{{ it.category }}</td>
					<td>{{ it.Source or "—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <p class="empty">No weapon inventory available at this time.</p>
      {% endif %}
    </section>

    <!-- Magic -->
    <section id="Magic" class="pf-card mt-16">
      <div class="pf-section__header"><h2 style="margin:0;">Magic Items</h2><a href="#top" class="pf-link-chip" style="float: right;">↑ Top</a></div>
      {% if magic_items %}
        <div class="p-12">
          <div class="pf-table-wrap">
            <table id="RarityMagic" class="pf-table zebra">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Level</th>
                  <th>Rarity</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Category</th>
				  <th>Source</th>
                </tr>
              </thead>
				<tbody>
				  {% for it in magic_items %}
					{# normalize strings once #}
					{% set n = ((it.name or '')|string)|lower %}
					{% set c = ((it.category or '')|string)|lower %}
					{# spellbook if category contains 'spellbook' or name starts with 'spellbook' #}
					{% set is_sb = ('spellbook' in c) or (n[:9] == 'spellbook') %}
					<tr class="mi-row {% if is_sb %}is-spellbook{% endif %}">
					  <td class="name-cell">
						{% if is_sb and it.details_html %}
						  <details class="mi-accordion">
							<summary>
							  <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">{{ it.name }}</a>
							  {% if it.critical %}
								<span class="badge critical" style="margin-left:6px;">Critical</span>
							  {% endif %}
							  {% if it.is_3pp %}
								<span class="badge thirdparty" title="Third‑Party Publisher" style="margin-left:6px;">3PP</span>
							  {% endif %}
							</summary>
							{{ it.details_html | safe }}
						  </details>
						{% else %}
						  <a href="{{ aon_url(it.aon_target or it.name) }}" target="_blank" rel="noopener">{{ it.name }}</a>
						  {% if it.critical %}
							<span class="badge critical" style="margin-left:6px;">Critical</span>
						  {% endif %}
						  {% if it.is_3pp %}
							<span class="badge thirdparty" title="Third‑Party Publisher" style="margin-left:6px;">3PP</span>
						  {% endif %}
						{% endif %}
					  </td>

					  <td>{{ it.level }}</td>
					  <td>
						{% set r = (it.rarity or 'Common')|lower %}
						<span class="badge rarity-chip {{ r }}">{{ it.rarity or 'Common' }}</span>
					  </td>
					  <td>{{ it.price }}</td>
					  <td>{{ it.quantity }}</td>
					  <td>{{ it.category }}</td>
					  <td>{{ it.Source or "—" }}</td>
					</tr>
				  {% endfor %}
				</tbody>
            </table>
          </div>
        </div>
      {% else %}
        <p class="empty">No magic inventory available at this time.</p>
      {% endif %}
    </section>

    <script>
      function exportToCSV() {
        const csvHeaders = ["Section", "Name", "Level", "Rarity", "Price", "Quantity", "Category"];
        let csvContent = "data:text/csv;charset=utf-8," + csvHeaders.join(",") + "\n";
        const allTables = document.querySelectorAll('[id^="Rarity"]');
        allTables.forEach(table => {
          const sectionTitle = table.closest("section")?.querySelector(".pf-section__header h2")?.innerText?.trim()
                              || table.id.replace(/^Rarity/, "");
          const rows = table.querySelectorAll("tbody tr");
          rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll("td")).map(cell =>
              '"' + cell.innerText.replace(/"/g, '""') + '"'
            );
            csvContent += ['"'+sectionTitle.replace(/"/g,'""')+'"', ...cells].join(",") + "\n";
          });
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "treasure_results.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // Dynamic document title reflecting filters
      (function() {
        const shop = "{{ (shop_type or 'Any') | replace('_',' ') | title }}";
        const size = "{{ shop_size|title }}";
        const disp = "{{ disposition|title }}";
        const pl   = "{{ party_level }}";
        document.title = `Inventory – ${shop} / ${size} / ${disp} / PL ${pl}`;
      })();
    </script>

  </div><!-- .pf-app -->

</main>
{% if channel and roll_id %}
<script>
(function() {
  const channel = {{ channel|tojson }};
  const rollId = {{ roll_id|tojson }};
  if (!channel || !rollId) {
    return;
  }

  const params = new URLSearchParams(window.location.search);
  params.set("channel", channel);
  params.set("roll_id", rollId);
  params.delete("snapshot");
  const newQuery = params.toString();
  const newUrl = window.location.pathname + (newQuery ? "?" + newQuery : "");
  if (window.location.href !== window.location.origin + newUrl) {
    history.replaceState(null, document.title, newUrl);
  }

  const copyBtn = document.getElementById("copy-share-link");
  const statusEl = document.getElementById("copy-share-status");
  if (!copyBtn) {
    return;
  }
  const shareUrl = window.location.origin + newUrl;
  copyBtn.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(shareUrl);
      if (statusEl) {
        statusEl.textContent = "Link copied!";
      }
    } catch (err) {
      if (statusEl) {
        statusEl.textContent = "Copy failed. You can manually share " + shareUrl;
      }
    }
  });
})();
</script>
{% endif %}
</body>
</html>
